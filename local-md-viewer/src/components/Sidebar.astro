---
import type { FileTreeNode } from '../lib/files';

interface Props {
  tree: FileTreeNode[];
  currentPath?: string;
}

const { tree, currentPath } = Astro.props;

function renderTree(nodes: FileTreeNode[], depth = 0): string {
  return nodes.map(node => {
    const isActive = currentPath === node.path;
    const indent = depth * 16;
    
    if (node.type === 'directory') {
      return `
        <div class="tree-folder" style="--indent: ${indent}px">
          <div class="folder-header">
            <svg class="folder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <span class="folder-name">${node.name}</span>
          </div>
          <div class="folder-children">
            ${node.children ? renderTree(node.children, depth + 1) : ''}
          </div>
        </div>
      `;
    }
    
    return `
      <a 
        href="/view/${encodeURIComponent(node.path)}" 
        class="tree-file ${isActive ? 'active' : ''}"
        style="--indent: ${indent}px"
      >
        <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <path d="M14 2v6h6"/>
          <path d="M16 13H8"/>
          <path d="M16 17H8"/>
          <path d="M10 9H8"/>
        </svg>
        <span class="file-name">${node.name}</span>
      </a>
    `;
  }).join('');
}
---

<aside class="sidebar">
  <div class="sidebar-header">
    <a href="/" class="logo">
      <span class="logo-mark">F</span>
      <span class="logo-text">Folio</span>
    </a>
    <span class="tagline">Document Viewer</span>
  </div>
  
  <div class="search-container">
    <input 
      type="search" 
      placeholder="Search documents..." 
      class="search-input"
      id="search-input"
    />
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
  </div>
  
  <nav class="file-tree" id="file-tree">
    <Fragment set:html={renderTree(tree)} />
  </nav>
  
  <div class="sidebar-footer">
    <span class="file-count">{tree.length} items</span>
  </div>
</aside>

<style>
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--bg-surface);
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    z-index: 100;
  }

  .sidebar-header {
    padding: 24px 20px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }

  .logo-mark {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 600;
    color: var(--accent);
    line-height: 1;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-glow);
    border-radius: 8px;
  }

  .logo-text {
    font-family: var(--font-display);
    font-size: 24px;
    font-weight: 500;
    color: var(--text-primary);
    letter-spacing: 0.02em;
  }

  .tagline {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: block;
    margin-left: 46px;
  }

  .search-container {
    padding: 16px 20px;
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 10px 12px 10px 38px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent-dim);
    background: var(--bg-deep);
  }

  .search-icon {
    position: absolute;
    left: 32px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    color: var(--text-muted);
    pointer-events: none;
  }

  .file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 8px 12px;
  }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-subtle);
  }

  .file-count {
    font-size: 12px;
    color: var(--text-muted);
  }

  /* Tree styles */
  :global(.tree-folder) {
    margin-bottom: 4px;
  }

  :global(.folder-header) {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    padding-left: calc(12px + var(--indent, 0px));
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  :global(.folder-icon) {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.6;
  }

  :global(.folder-name) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.folder-children) {
    margin-top: 2px;
  }

  :global(.tree-file) {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    padding-left: calc(12px + var(--indent, 0px));
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 14px;
    transition: all 0.15s ease;
    margin-bottom: 2px;
  }

  :global(.tree-file:hover) {
    background: var(--bg-elevated);
    color: var(--text-primary);
  }

  :global(.tree-file.active) {
    background: var(--accent-glow);
    color: var(--accent);
  }

  :global(.file-icon) {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    opacity: 0.7;
  }

  :global(.tree-file.active .file-icon) {
    opacity: 1;
  }

  :global(.file-name) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>

<script>
  // Client-side search functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const fileTree = document.getElementById('file-tree');
  
  if (searchInput && fileTree) {
    const allFiles = fileTree.querySelectorAll('.tree-file');
    const allFolders = fileTree.querySelectorAll('.tree-folder');
    
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      
      if (!query) {
        // Show all items
        allFiles.forEach(file => (file as HTMLElement).style.display = '');
        allFolders.forEach(folder => (folder as HTMLElement).style.display = '');
        return;
      }
      
      // Filter files
      allFiles.forEach(file => {
        const name = file.querySelector('.file-name')?.textContent?.toLowerCase() || '';
        const matches = name.includes(query);
        (file as HTMLElement).style.display = matches ? '' : 'none';
      });
      
      // Show folders that have visible children
      allFolders.forEach(folder => {
        const visibleChildren = folder.querySelectorAll('.tree-file:not([style*="display: none"])');
        (folder as HTMLElement).style.display = visibleChildren.length > 0 ? '' : 'none';
      });
    });
  }
</script>
